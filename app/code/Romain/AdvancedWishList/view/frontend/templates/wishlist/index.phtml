<?php

/** @var \Romain\AdvancedWishList\Block\WishList\Index $block */
$wishlists = $block->getCustomerWishLists();
$isLoggedIn = $block->isCustomerLoggedIn();
?>

<div class="advanced-wishlist-page">

    <div class="wishlist-actions">
        <!-- Le composant modal sera rendu ici -->
        <div id="wishlist-modal-container" data-bind="scope: 'advanced_wishlist_modal'">
            <!-- ko template: getTemplate() --><!-- /ko -->
        </div>
    </div>

    <div class="wishlist-content" data-bind="scope: 'advanced_wishlist_modal'">
        <?php if (!$isLoggedIn): ?>
            <div class="message info">
                <span><?= __('Please log in to view your wishlists.') ?></span>
                <a href="<?= $block->escapeUrl($block->getUrl('customer/account/login')) ?>" class="action login">
                    <?= __('Log In') ?>
                </a>
            </div>
        <?php else: ?>
            <div class="wishlists-grid">
                <div class="wishlist-items">
                    <?php foreach ($wishlists as $wishlist): ?>
                        <?php $block->setWishList((int)$wishlist['wishlist_id']); ?>
                        <div class="wishlist-item <?= $wishlist['is_default'] ? 'default' : '' ?>">
                            <div class="wishlist-card">
                                <div class="wishlist-header">
                                    <h3 class="wishlist-name">
                                        <a href="<?= $block->escapeUrl($block->getWishListViewUrl((int)$wishlist['wishlist_id'])) ?>"
                                        class="advanced-wishlist-link" data-id="<?= $wishlist['wishlist_id'] ?>"
                                        data-url="<?= $block->escapeUrl($block->getWishListViewUrl((int)$wishlist['wishlist_id'])) ?>">
                                        <?= $block->escapeHtml($wishlist['name']) ?>
                                        <?php if ($wishlist['is_default']): ?>
                                            <span class="default-badge"><?= __('Default') ?></span>
                                        <?php endif; ?>
                                        </a>
                                    </h3>

                                    <div class="wishlist-actions">

                                        <?php if (!$wishlist['is_default']): ?>
                                            <button type="button"
                                                class="action secondary delete"
                                                onclick="confirmDelete('<?= $block->escapeUrl($block->getWishListDeleteUrl((int)$wishlist['wishlist_id'])) ?>', '<?= $block->escapeHtml($wishlist['name']) ?>')"
                                                title="<?= __('Supprimer') ?>">
                                                <?= __('Supprimer') ?>
                                            </button>
                                        <?php endif; ?>
                                    </div>
                                </div>

                                <div class="wishlist-info">
                                    <?php if (!empty($wishlist['description'])): ?>
                                        <p class="wishlist-description">
                                            <?= $block->escapeHtml($wishlist['description']) ?>
                                        </p>
                                    <?php endif; ?>

                                    <div class="wishlist-meta">
                                        <span class="created-date">
                                            <?= __('Created: %1', $block->formatWishListDate($wishlist['created_at'])) ?>
                                        </span>

                                        <span class="visibility">
                                            <?= $wishlist['is_public'] ? __('Public') : __('Private') ?>
                                        </span>
                                    </div>
                                </div>

                                <div class="wishlist-stats">
                                    <!-- Vous pouvez ajouter ici le nombre d'items si vous avez une table de liaison -->
                                    <span class="item-count">
                                        <?= $block->getItemsCount((int)$wishlist['wishlist_id']) . ' item (s)' ?> <!-- À remplacer par le vrai count -->
                                    </span>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        <?php endif; ?>
    </div>
</div>

<script type="text/x-magento-init">
    {
    "*": {
        "Magento_Ui/js/core/app": <?= /* @escapeNotVerified */ $block->getJsLayout(); ?>
    }
}
</script>

<script>

    function confirmDelete(deleteUrl, wishlistName) {
        if (confirm('<?= __("Are you sure you want to delete the wishlist %s ?") ?>'.replace('%s', wishlistName))) {
            console.log(deleteUrl);
            fetch(deleteUrl, {
                method: 'GET',
                credentials: 'same-origin',
            })
                .then(() => {
                    // Redirection manuelle
                    window.location.href = '/advancedwishlist';
                    location.reload();
                })
                .catch((error) => {
                    console.error(error);
                    alert("Erreur lors de la suppression.");
                });
        }
    }

    // Fonction pour copier le lien de partage
    function copyShareLink(shareUrl) {
        navigator.clipboard.writeText(shareUrl).then(function() {
            // Afficher un message de succès
            alert('<?= __("Share link copied to clipboard!") ?>');
        });
    }
</script>
